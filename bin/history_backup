#!/usr/bin/env sh
(
  set -o errexit
  set -o noclobber
  set -o noglob
  set -o nounset
  set -o verbose
  set -o xtrace
  file="${HISTFILE:-${HOME%/}'/.'"${SHELL##*/}"'_history'}"
  # verify `$HISTFILE` exists and is not empty
  test -s "${file-}" &&
    # ensure a backup directory exists
    command mkdir -p -- "${file-}"'_bak' &&
    # verify `$HISTFILE` has changed since the last backup...
    test "$(
      command find -- "${file-}" -prune -newer "$(
        # ...by comparing it to the newest file in the backup directory
        command find -- "${file-}"'_bak' \
          ! -path '*/.git/*' \
          -type f \
          -exec /bin/ls -1 -t -- {} + 2>/dev/null |
          command sed -e '1q' -
      )"
    )" != '' &&
    command cp -- "${file-}" "${file-}"'_bak/'"${file##*/}"'_'"$(command date -- '+%Y%m%d')"
)
